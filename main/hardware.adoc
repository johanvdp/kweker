:toc:
:toc-title: Table of contents
:toclevels: 5
:sectnums:

== Hardware

== Controller

The controller module includes the user interface is named CTRL to have short pin naming.
It consists of multiple modules that are wired inside. The outside is presented as follows.

.CTRL screw terminals
[%autowidth]
|===
| pin  | function | description

3+| power supply input

| *1*  | 5V  |

| *2*  | GND |

3+| humidity & temperature sensor

| *3*  | 5V   |

| *4*  | GND  |

| *5*  | DATA | 1 wire serial TTL (3.3V)

3+| CO2 concentration sensor

| *6*  | 5V       |

| *7*  | GND      |

| *8*  | TX       | serial transmit TTL (3.3V)

| *9*  | RX       | serial receive TTL (3.3V)

3+| Digital actuator control
| *10* | 5V       |

| *11* | GND      |
| *12* | OUT1     | output 1 (3.3V)

| *13* | OUT2     | output 2 (3.3V)

| *14* | OUT3     | output 3 (3.3V)

| *15* | OUT4     | output 4 (3.3V)

| *16* |          |

| *17* |          |

| *18* |          |

| *19* |          |

|===

=== ESP32 module

.ESP32 module left
[%autowidth]
|===
| pin  | name | function

| *1*  | 3.3V |

| *2*  | EN   | reset

| *3*  | P36  |

| *4*  | P39  |

| *5*  | P34  |

| *6*  | P35  |

| *7*  | P32  |

| *8*  | P33  |

| *9*  | P25  |

| *10* | P26  |

| *11* | P27  |

| *12* | P14  | HSPICLK(2)

| *13* | P12  | HSPIQ(2)

| *14* | GND  |

| *15* | P13  | HSPID(2)

| *16* | P9   | SD_DATA_2(1), U1RXD(5)

| *17* | P10  | SD_DATA_3(1), U1TXD(5)

| *18* | P11  | SD_CMD(1)

| *19* | 5V   |
|===

.ESP32 module right
[%autowidth]
|===
| pin  | name | function

| *38* | GND  |

| *37* | P23  | *VSPID(2)*

| *36* | P22  | VSPIWP(2)

| *35* | P1   | *U0TXD(1)*

| *34* | P3   | *U0RXD(1)*

| *33* | P21  | VSPIHD(2)

| *32* | GND  |

| *31* | P19  | *VSPIQ(2)*

| *30* | P18  | *VSPICLK(2)*

| *29* | P5   | *VSPICS0(2)*

| *28* | P17  | U2TXD(5)

| *27* | P16  | U2RXD(5)

| *26* | P4   | HSPIHD(2)

| *25* | P0   | GPIO0(1,3) boot

| *24* | P2   | GPIO2(1,3) led, HSPIWP(2)
| *23* | P15  | HSPICS0(2)

| *22* | P8   | SD_DATA_1(1)

| *21* | P7   | SD_DATA_O(1)

| *20* | P6   | SD_CLK(1)

|===

=== User interface module

The user interface is a small 3.5" LCD display with touch screen.
The MSP3520 module is build around a ILI9488 LCD driver, a XPT2046 touch screen controller and communicates using an SPI interface.

.MSP3520 module
[%autowidth]
|===
| pin  | function  | description

| 1.1  | VCC       | 3.3..5V
| 1.2  | GND       |
| 1.3  | CS        | LCD chip select
| 1.4  | RESET     | LCD reset
| 1.5  | DC/RS     | LCD register / data selection
| 1.6  | SDI(MOSI) | LCD SPI bus write data
| 1.7  | SCK       | LCD SPI bus clock
| 1.8  | LED       | LCD backlight control (3.3V is on)
| 1.9  | SDO(MISO) | LCD SPI bus read data (optional)
| 1.10 | T_CLK     | Touch screen SPI bus clock
| 1.11 | T_CS      | Touch screen chip select
| 1.12 | T_DIN     | Touch screen SPI bus write data
| 1.13 | T_DO      | Touch screen SPI bus read data
| 1.14 | T_IRQ     | Touch screen interupt detect
| 2.1  | SD_CS     | SD card chip select
| 2.2  | SD_MOSI   | SD card SPI bus write data
| 2.3  | SD_MISO   | SD card SPI bus read data
| 2.4  | SD_SCK    | SD card SPI bus clock
|===

.MSP3520 module other
[%autowidth]
|===
| parameter | value

| operating voltage | 3.3V / 5V
| operating current | 90 mA
|===

== Sensors

=== CO2 concentration

The CO2 concentration is measured using an infrared CO2 sensor, an MH-Z19B module.
Using the serial port (UART TTL level 3.3V) for communication.
Software settings and protocol see datasheet.

.MH-Z19B module
[%autowidth]
|===
| pin | name | description

| 1   |      | analog output (unused)
| 2   |      | none
| 3   | GND  | negative
| 4   | VIN  | positive
| 5   | RXD  | TTL level data input
| 6   | TXD  | TTL level data output
| 7   |      | none
|===

.MH-Z19B module other
[%autowidth]
|===
| parameter | value

| operating voltage | 4.5..5.5 VDC
| operating current | 150 mA peak
| operating temperature | -10..50C
| operating humidity | 0..90%RH
| lifespan | >5 years
| detection range | 0..2000 ppm
| preheat time | 3 min
| response time | < 120 s
| accuracy | +/-(50 ppm + 5% reading value)
| output signal | serial port (TTL level 3.3V)
|===

=== Humidity & temperature

An AM2301A sensor measures both relative humidity and temperature.

.AM2301A module
[%autowidth]
|===
| pin | color | function

.2+| 1
.2+| red
| VDD (3.3..5.2V)
| recommend 5.0V
| 2 | yellow | serial data, dual port
| 3 | black  | GND
| 4 |        | not connected
|===

.MH-Z19B module other
[%autowidth]
|===
| parameter | value

2+|*relative humidity*
| resolution | 0.1 %RH
| range | 0..99.9 %RH
| accuracy | +/- 3% RH

| repeatability | +/- 1 %RH
| response | <6 s (1/e, 63%)
| drift | <0.5 %RH/y

2+|*relative temperature*
.2+| resolution
| 0.1 C
| 16 bit
| accuracy | +/- 1 C

| range | -40..80 C
| repeatability | +/- 0.2 C
| response | <10 s (1/e, 63%)
| drift | <0.3 C/y

|===

== Actuators

=== Solid state relay

Used to switch devices on and off.

.SSR-10 DA module
[%autowidth]
|===
| pin | symbol           | description

| 1   | <device>.AC.1

.2+| AC switch

| 2   | <device>.AC.2

| 3   | <device>.DC.POS

.2+| DC control

| 4   | <device>.DC.NEG

|===

.SSR-10 DA module limits
[%autowidth]
|===
| parameter | value

| DC control | 3..32V DC
| AC switch voltage | 24..380V AC
| AC switch current | < 10 A
|===

.SSR-10 DA module usage
[%autowidth]
|===
| device | description

| SSR1 | Grow lamp

| SSR2 | Exhaust fan

| SSR3 | Recirculation fan

| SSR4 | Heater

|===

== Power supply
[%autowidth]
|===
| pin  | function

| 1, 2 | V-

.2+| 5 VDC
| 3, 4 | V+
| 5    | AC/L
.2+| 230 VAC
| 6    | AC/N
|===

== Mains wiring
[%autowidth]
|===
| pin  | connection

| L1.1  | (IN.L)
| L1.2  | L2.1
| L1.3  | PSU.5
| L1.4  |

| N1.1  | (IN.N)
| N1.2  | N2.1
| N1.3  | PSU.6
| N1.4  |

| PE1.1 | (IN.PE)
| PE1.2 | PE2.1

| L2.1  | (L1.2)
| L2.2  |  
| L2.3  |
| L2.4  | 
| L2.5  | SSR1.AC.1 
| L2.6  | SSR2.AC.1
| L2.7  | SSR3.AC.1
| L2.8  | SSR4.AC.1

| N2.1  | (N1.2)
| N2.2  |
| N2.3  |
| N2.4  |
| N2.5  | WCD1.N
| N2.6  | WCD2.N
| N2.7  | WCD3.N
| N2.8  | WCD4.N

| PE2.1 | (PE1.2)
| PE2.2 | 
| PE2.3 | PE3.1 
| PE2.4 | 

| SSR1.AC.2 | WCD1.L
| SSR2.AC.2 | WCD2.L
| SSR3.AC.2 | WCD3.L
| SSR4.AC.2 | WCD4.L

| PE3.1 | (PE2.3)
| PE3.2 | 
| PE3.3 | 
| PE3.4 | 
| PE3.5 | WCD1.PE
| PE3.6 | WCD2.PE
| PE3.7 | WCD3.PE
| PE3.8 | WCD4.PE

|===

== Layout

Modules are placed on DIN rails.

.Module sizes
[%autowidth]
|===
|name|width(cm)|height(cm)

3+|RAIL1
|CPU|14.5|9.0
|PSU|5.5|9.0
|L1 |1.0|4.0
|N1 |1.0|4.0
|PE1 |1.0|4.0
|WIDTH
2+|23.0

3+|RAIL2
|SSR|5.0|8.0
|L2 |2.0|4.0
|N2 |2.0|4.0
|PE2 |1.0|4.0
|WIDTH
2+|10.0

3+|RAIL3
|WCD|4.5|8.0
|PE3 |2.0|4.0
|WIDTH
2+|6.5
|===

.Module layout
[ditaa]
....

     +---------------------------+ +---------+
     |                           | |         |
     |                           | |         |   +-+-+-+ +-+-+-+ +-+-+-+
  ---|                           |-|         |---|     |-|     |-|     |---
     | CPU                       | | PSU     |   | L1  | | N1  | | PE1 |
     |                           | |         |   |     | |     | |     |
  ---|                           |-|         |---|     |-|     |-|     |---
     |                           | |         |   +-+-+-+ +-+-+-+ +-+-+-+
     +---------------------------+ |         |
                                   +---------+

     +--------+ +--------+ +--------+ +--------+
     |        | |        | |        | |        | +-+-+-+-+-+ +-+-+-+-+-+ +-+-+-+
  ---|        |-|        |-|        |-|        |-|         |-|         |-|     |---
     | SSR1   | | SSR2   | | SSR3   | | SSR4   | | L2      | | N2      | | PE2 |
     |        | |        | |        | |        | |         | |         | |     |
  ---|        |-|        |-|        |-|        |-|         |-|         |-|     |---
     |        | |        | |        | |        | +-+-+-+-+-+ +-+-+-+-+-+ +-+-+-+
     +--------+ +--------+ +--------+ +--------+

     +---------+ +---------+ +---------+ +---------+
     |         | |         | |         | |         |
     |         | |         | |         | |         |  +-+-+-+-+-+
  ---|         |-|         |-|         |-|         |--|         |---
     | WCD1    | | WCD2    | | WCD3    | | WCD4    |  | PE3     |
     |         | |         | |         | |         |  |         |
  ---|         |-|         |-|         |-|         |--|         |---
     |         | |         | |         | |         |  +-+-+-+-+-+
     |         | |         | |         | |         |
     +---------+ +---------+ +---------+ +---------+

....
